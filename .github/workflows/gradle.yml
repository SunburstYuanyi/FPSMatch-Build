name: Java CI with Gradle

on:
  workflow_dispatch:    # 添加手动触发支持
    inputs:
      build-type:
        description: '选择构建类型'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
          - clean-build
      java-version:
        description: '选择Java版本'
        required: true
        default: '17'
        type: choice
        options:
          - '17'
          - '21'
      include-tests:
        description: '是否包含测试'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK ${{ github.event.inputs.java-version || '17' }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ github.event.inputs.java-version || '17' }}
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: |
        # 根据选择的构建类型执行不同的命令
        if [ "${{ github.event.inputs.build-type }}" = "clean-build" ]; then
          ./gradlew clean build --stacktrace --info
        elif [ "${{ github.event.inputs.build-type }}" = "debug" ]; then
          ./gradlew build --stacktrace --info --debug
        else
          ./gradlew build --stacktrace --info
        fi
        
        # 根据测试选项决定是否运行测试
        if [ "${{ github.event.inputs.include-tests }}" = "true" ]; then
          ./gradlew test --info
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: ModArtifacts-${{ github.event.inputs.build-type }}-${{ github.run_number }}
        path: |
          build/libs/*.jar
          build/reports/tests/test/
        retention-days: 5

    - name: Show build info
      run: |
        echo "构建类型: ${{ github.event.inputs.build-type }}"
        echo "Java版本: ${{ github.event.inputs.java-version }}"
        echo "包含测试: ${{ github.event.inputs.include-tests }}"
        echo "构建编号: ${{ github.run_number }}"
